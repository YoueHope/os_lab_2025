#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/wait.h>
#include <time.h>

void create_zombie() {
    pid_t pid = fork();
    
    if (pid == 0) {
        // Дочерний процесс
        printf("Дочерний процесс (PID: %d) запущен\n", getpid());
        printf("Дочерний процесс (PID: %d) завершается, становясь зомби\n", getpid());
        exit(0); // Завершаем дочерний процесс
    } else if (pid > 0) {
        // Родительский процесс
        printf("Родительский процесс (PID: %d) создал дочерний процесс (PID: %d)\n", 
               getpid(), pid);
        printf("Родительский процесс НЕ вызывает wait(), поэтому дочерний процесс станет зомби\n");
        
        // Ждем некоторое время, чтобы можно было наблюдать зомби-процесс
        sleep(10);
        
        // Теперь собираем статус завершения
        printf("Родительский процесс вызывает wait() для уборки зомби\n");
        wait(NULL);
        printf("Зомби-процесс убран\n");
    } else {
        perror("Ошибка при создании процесса");
        exit(1);
    }
}

void prevent_zombie_with_wait() {
    pid_t pid = fork();
    
    if (pid == 0) {
        // Дочерний процесс
        printf("Дочерний процесс (PID: %d) запущен\n", getpid());
        sleep(2);
        printf("Дочерний процесс (PID: %d) завершается\n", getpid());
        exit(0);
    } else if (pid > 0) {
        // Родительский процесс
        printf("Родительский процесс (PID: %d) создал дочерний процесс (PID: %d)\n", 
               getpid(), pid);
        printf("Родительский процесс ожидает завершения дочернего процесса...\n");
        
        wait(NULL); // Ожидаем завершение дочернего процесса
        printf("Дочерний процесс корректно завершен, зомби не создан\n");
    } else {
        perror("Ошибка при создании процесса");
        exit(1);
    }
}

void prevent_zombie_with_signal_handler() {
    // В реальной программе здесь был бы обработчик сигнала SIGCHLD
    pid_t pid = fork();
    
    if (pid == 0) {
        // Дочерний процесс
        printf("Дочерний процесс (PID: %d) запущен\n", getpid());
        sleep(2);
        printf("Дочерний процесс (PID: %d) завершается\n", getpid());
        exit(0);
    } else if (pid > 0) {
        // Родительский процесс
        printf("Родительский процесс (PID: %d) создал дочерний процесс (PID: %d)\n", 
               getpid(), pid);
        printf("Родительский процесс продолжает работу (можно установить обработчик SIGCHLD)\n");
        
        // В реальном сценарии здесь родитель продолжал бы работу,
        // а зомби предотвращался бы обработчиком SIGCHLD
        sleep(5);
        
        // Но для демонстрации все равно вызываем wait()
        wait(NULL);
    } else {
        perror("Ошибка при создании процесса");
        exit(1);
    }
}

int main() {
    printf("=== Демонстрация зомби-процессов ===\n\n");
    
    printf("1. Создание зомби-процесса:\n");
    create_zombie();
    
    printf("\n2. Предотвращение зомби с помощью wait():\n");
    prevent_zombie_with_wait();
    
    printf("\n3. Предотвращение зомби (имитация использования обработчика сигналов):\n");
    prevent_zombie_with_signal_handler();
    
    printf("\n=== Демонстрация завершена ===\n");
    
    return 0;
}
